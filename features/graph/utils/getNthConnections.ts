import { EnhancedPerson } from "@/features/D3/utils/getNodePositions";
import { Tables } from "@/types/dbTypes";

const getNthConnections = (
  nodeId: number,
  allPeople: EnhancedPerson[],
  allConnections: Tables<"connections">[],
  n: 0 | 1 | 2 = 0,
): {
  people: EnhancedPerson[];
  connections: Tables<"connections">[];
} | null => {
  const rootNode = allPeople.find((p) => !p.source_node_ids);
  if (!rootNode) return null;

  const getConnectedPeople = (sourceIds: string[]): EnhancedPerson[] => {
    return allPeople.filter((p) =>
      sourceIds.some((id) => p.source_node_ids?.includes(id)),
    );
  };

  const getSpousesAndChildren = (
    people: EnhancedPerson[],
  ): EnhancedPerson[] => {
    return people.flatMap((person) => {
      if (!person.partner_id) return [];

      const spouse = allPeople.find((p) => p.id === person.partner_id);
      const children = spouse
        ? allPeople.filter(
            (p) =>
              p.source_node_ids?.includes(person.id.toString()) &&
              p.source_node_ids.includes(spouse.id.toString()),
          )
        : [];

      return [spouse, ...children].filter(Boolean) as EnhancedPerson[];
    });
  };

  let connectedPeople: EnhancedPerson[] = [];
  let sourceIds = [nodeId.toString()];

  for (let i = 0; i <= n; i++) {
    const newPeople = getConnectedPeople(sourceIds);
    connectedPeople = [...connectedPeople, ...newPeople];
    sourceIds = newPeople.map((p) => p.id.toString());

    if (i === 0) {
      const spousesAndChildren = getSpousesAndChildren(newPeople);
      connectedPeople = [...connectedPeople, ...spousesAndChildren];
    }
  }

  connectedPeople = [...new Set([...connectedPeople, rootNode])];

  const connectedPeopleIds = new Set(connectedPeople.map((p) => p.id));

  const relevantConnections = allConnections.filter(
    (conn) =>
      connectedPeopleIds.has(conn.source_node_id) &&
      connectedPeopleIds.has(conn.target_node_id),
  );

  return {
    people: connectedPeople,
    connections: relevantConnections,
  };
};

export { getNthConnections };

// length = 14
const NODES_TO_SHOW = [
  {
    created_at: "2024-07-20T14:16:38.501838+00:00",
    date_of_birth: "1992-02-15",
    date_of_death: "2024-07-01",
    first_name: "Bob",
    gift_ideas: null,
    group_id: 1,
    group_name: "Friends",
    hiddenConnections: 0,
    id: 6,
    last_name: "Johnson",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "b ah b",
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T14:13:40.640285+00:00",
    date_of_birth: "1987-06-01",
    date_of_death: "2022-01-01",
    first_name: "Nolast",
    gift_ideas: null,
    group_id: 1,
    group_name: "Friends",
    hiddenConnections: 0,
    id: 5,
    last_name: null,
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T19:35:40.425788+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Cody",
    gift_ideas: null,
    group_id: 2,
    group_name: "Best Friends",
    hiddenConnections: 0,
    id: 19,
    last_name: "Zwier",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: "Code",
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T14:12:10.751453+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Donnie",
    gift_ideas: null,
    group_id: 2,
    group_name: "Best Friends",
    hiddenConnections: 0,
    id: 3,
    last_name: "Irons",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "dah nee",
    preferred_name: "Don",
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T14:13:11.728096+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Steve",
    gift_ideas: ["Bachstuff1", "Bachstuff2"],
    group_id: 2,
    group_name: "Best Friends",
    hiddenConnections: 0,
    id: 4,
    last_name: "Smith",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "st EE v",
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T14:08:06.754277+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Aaron",
    gift_ideas: ["Baby thing1", "Babything2", "Workout app"],
    group_id: 2,
    group_name: "Best Friends",
    hiddenConnections: 4,
    id: 2,
    last_name: "Mackenzie",
    maiden_name: null,
    partner_id: 9,
    partner_type: "spouse",
    phonetic_name: "Ah run",
    preferred_name: "Amac",
    sex: "male",
    shownConnections: 2,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T19:14:07.652311+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Jeff",
    gift_ideas: null,
    group_id: 3,
    group_name: "Coworkers",
    hiddenConnections: 0,
    id: 18,
    last_name: "Cranfield",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T19:13:48.184445+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Ashley",
    gift_ideas: null,
    group_id: 3,
    group_name: "Coworkers",
    hiddenConnections: 0,
    id: 17,
    last_name: "Cranfield",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: null,
    sex: "female",
    shownConnections: 0,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T19:13:06.095934+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "John",
    gift_ideas: null,
    group_id: 3,
    group_name: "Coworkers",
    hiddenConnections: 0,
    id: 16,
    last_name: "Cheramie",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T14:18:29.73753+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Michelle",
    gift_ideas: null,
    group_id: 3,
    group_name: "Coworkers",
    hiddenConnections: 0,
    id: 8,
    last_name: null,
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "m ih - sh EH l",
    preferred_name: null,
    sex: "female",
    shownConnections: 0,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T14:17:51.921577+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Drake",
    gift_ideas: null,
    group_id: 3,
    group_name: "Coworkers",
    hiddenConnections: 0,
    id: 7,
    last_name: "Davis",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "dr AI k",
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
  },
  {
    created_at: "2024-07-20T14:24:47.404169+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Rachel",
    gift_ideas: null,
    group_id: null,
    group_name: null,
    hiddenConnections: 0,
    id: 9,
    last_name: "Mackenzie",
    maiden_name: null,
    partner_id: 2,
    partner_type: "spouse",
    phonetic_name: null,
    preferred_name: "Rach",
    sex: "female",
    shownConnections: 1,
    source_node_ids: ["2"],
  },
  {
    created_at: "2024-07-20T14:25:12.091096+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Levi",
    gift_ideas: null,
    group_id: null,
    group_name: null,
    hiddenConnections: 0,
    id: 10,
    last_name: "Mackenzie",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["2", "9"],
  },
  {
    created_at: "2024-07-20T14:07:07.332245+00:00",
    date_of_birth: "2000-10-01",
    date_of_death: null,
    first_name: "Shawn",
    gift_ideas: null,
    group_id: null,
    group_name: null,
    hiddenConnections: 0,
    id: 1,
    last_name: "Ballay",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "sh AW n",
    preferred_name: null,
    sex: "male",
    shownConnections: 11,
    source_node_ids: null,
  },
];

// length = 14
const RENDERED_NODES = [
  {
    created_at: "2024-07-20T14:16:38.501838+00:00",
    date_of_birth: "1992-02-15",
    date_of_death: "2024-07-01",
    first_name: "Bob",
    gift_ideas: null,
    group_id: 1,
    group_name: "Friends",
    hiddenConnections: 0,
    id: 6,
    index: 0,
    last_name: "Johnson",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "b ah b",
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
    vx: -0.007596746870504859,
    vy: -0.007053214740906269,
    x: 271.31008730089934,
    y: 546.3757763060679,
  },
  {
    created_at: "2024-07-20T14:13:40.640285+00:00",
    date_of_birth: "1987-06-01",
    date_of_death: "2022-01-01",
    first_name: "Nolast",
    gift_ideas: null,
    group_id: 1,
    group_name: "Friends",
    hiddenConnections: 0,
    id: 5,
    index: 1,
    last_name: null,
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
    vx: -0.007781443432046904,
    vy: -0.006900947377508184,
    x: 233.10865533303843,
    y: 558.2032860011375,
  },
  {
    created_at: "2024-07-20T19:35:40.425788+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Cody",
    gift_ideas: null,
    group_id: 2,
    group_name: "Best Friends",
    hiddenConnections: 0,
    id: 19,
    index: 2,
    last_name: "Zwier",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: "Code",
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
    vx: -0.008115694384963353,
    vy: -0.006896521392456046,
    x: 72.8755450099588,
    y: 446.92974028427216,
  },
  {
    created_at: "2024-07-20T14:12:10.751453+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Donnie",
    gift_ideas: null,
    group_id: 2,
    group_name: "Best Friends",
    hiddenConnections: 0,
    id: 3,
    index: 3,
    last_name: "Irons",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "dah nee",
    preferred_name: "Don",
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
    vx: -0.007717973846528979,
    vy: -0.0066351427054554026,
    x: 123.28896185905757,
    y: 504.29314846646747,
  },
  {
    created_at: "2024-07-20T14:13:11.728096+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Steve",
    gift_ideas: ["Bachstuff1", "Bachstuff2"],
    group_id: 2,
    group_name: "Best Friends",
    hiddenConnections: 0,
    id: 4,
    index: 4,
    last_name: "Smith",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "st EE v",
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
    vx: -0.007940349914411265,
    vy: -0.006685053444939667,
    x: 89.15721198197394,
    y: 483.4536950528626,
  },
  {
    created_at: "2024-07-20T14:08:06.754277+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Aaron",
    gift_ideas: ["Baby thing1", "Babything2", "Workout app"],
    group_id: 2,
    group_name: "Best Friends",
    hiddenConnections: 4,
    id: 2,
    index: 5,
    last_name: "Mackenzie",
    maiden_name: null,
    partner_id: 9,
    partner_type: "spouse",
    phonetic_name: "Ah run",
    preferred_name: "Amac",
    sex: "male",
    shownConnections: 2,
    source_node_ids: ["1"],
    vx: -0.012160654104310963,
    vy: -0.001841555377031525,
    x: 88.90104404779075,
    y: 338.10539867974325,
  },
  {
    created_at: "2024-07-20T19:14:07.652311+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Jeff",
    gift_ideas: null,
    group_id: 3,
    group_name: "Coworkers",
    hiddenConnections: 0,
    id: 18,
    index: 6,
    last_name: "Cranfield",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
    vx: -0.0036514482078380765,
    vy: -0.01615654467722577,
    x: 317.1287798336309,
    y: 410.70363183324633,
  },
  {
    created_at: "2024-07-20T19:13:48.184445+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Ashley",
    gift_ideas: null,
    group_id: 3,
    group_name: "Coworkers",
    hiddenConnections: 0,
    id: 17,
    index: 7,
    last_name: "Cranfield",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: null,
    sex: "female",
    shownConnections: 0,
    source_node_ids: ["1"],
    vx: -0.007187773720199173,
    vy: -0.006349595296871395,
    x: 271.94644778627554,
    y: 262.12906037418475,
  },
  {
    created_at: "2024-07-20T19:13:06.095934+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "John",
    gift_ideas: null,
    group_id: 3,
    group_name: "Coworkers",
    hiddenConnections: 0,
    id: 16,
    index: 8,
    last_name: "Cheramie",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
    vx: -0.007833950850654558,
    vy: -0.005855005914585868,
    x: 318.79596386074786,
    y: 317.1418072564324,
  },
  {
    created_at: "2024-07-20T14:18:29.73753+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Michelle",
    gift_ideas: null,
    group_id: 3,
    group_name: "Coworkers",
    hiddenConnections: 0,
    id: 8,
    index: 9,
    last_name: null,
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "m ih - sh EH l",
    preferred_name: null,
    sex: "female",
    shownConnections: 0,
    source_node_ids: ["1"],
    vx: -0.00740787225954632,
    vy: -0.007035443608112625,
    x: 233.29235536620504,
    y: 251.90519210549604,
  },
  {
    created_at: "2024-07-20T14:17:51.921577+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Drake",
    gift_ideas: null,
    group_id: 3,
    group_name: "Coworkers",
    hiddenConnections: 0,
    id: 7,
    index: 10,
    last_name: "Davis",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "dr AI k",
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["1"],
    vx: -0.006615737472448477,
    vy: -0.006471236251062592,
    x: 308.40885283681894,
    y: 278.5263865894002,
  },
  {
    created_at: "2024-07-20T14:24:47.404169+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Rachel",
    gift_ideas: null,
    group_id: null,
    group_name: null,
    hiddenConnections: 0,
    id: 9,
    index: 11,
    last_name: "Mackenzie",
    maiden_name: null,
    partner_id: 2,
    partner_type: "spouse",
    phonetic_name: null,
    preferred_name: "Rach",
    sex: "female",
    shownConnections: 1,
    source_node_ids: ["2"],
    vx: -0.011583737188113946,
    vy: -0.0021107195752143007,
    x: 127.37749584346143,
    y: 327.27018525821705,
  },
  {
    created_at: "2024-07-20T14:25:12.091096+00:00",
    date_of_birth: null,
    date_of_death: null,
    first_name: "Levi",
    gift_ideas: null,
    group_id: null,
    group_name: null,
    hiddenConnections: 0,
    id: 10,
    index: 12,
    last_name: "Mackenzie",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: null,
    preferred_name: null,
    sex: "male",
    shownConnections: 0,
    source_node_ids: ["2", "9"],
    vx: -0.012938450668518453,
    vy: -0.0026473395995819863,
    x: 98.79150898899668,
    y: 299.37353673231837,
  },
  {
    created_at: "2024-07-20T14:07:07.332245+00:00",
    date_of_birth: "2000-10-01",
    date_of_death: null,
    first_name: "Shawn",
    fx: 196.5,
    fy: 386.5,
    gift_ideas: null,
    group_id: null,
    group_name: null,
    hiddenConnections: 0,
    id: 1,
    index: 13,
    last_name: "Ballay",
    maiden_name: null,
    partner_id: null,
    partner_type: null,
    phonetic_name: "sh AW n",
    preferred_name: null,
    sex: "male",
    shownConnections: 11,
    source_node_ids: null,
    vx: 0,
    vy: 0,
    x: 196.5,
    y: 386.5,
  },
];
